Bootstrap: docker
From: ubuntu:22.04

%files
    requirement.txt /opt/context/requirement.txt

%post
    export DEBIAN_FRONTEND=noninteractive
    ln -fs /usr/share/zoneinfo/Etc/UTC /etc/localtime
    echo "Etc/UTC" > /etc/timezone

    # Install LaTeX and font packages
    apt-get update && apt-get install -y dvipng texlive-latex-extra texlive-fonts-recommended cm-super

    # Install build dependencies for Python
    apt-get install -y wget build-essential libssl-dev zlib1g-dev \
        libncurses5-dev libncursesw5-dev libreadline-dev libsqlite3-dev \
        libgdbm-dev libdb5.3-dev libbz2-dev libexpat1-dev liblzma-dev \
        tk-dev libffi-dev uuid-dev

    # Use /usr/local/src for build workspace to avoid /tmp space issues
    PYTHON_VERSION="3.12.11"
    WORKDIR="/usr/local/src/python3.12"
    PYTHON_SRC="$WORKDIR/Python-$PYTHON_VERSION"
    PYTHON_TGZ="Python-$PYTHON_VERSION.tgz"

    mkdir -p "$WORKDIR"
    cd "$WORKDIR"
    wget "https://www.python.org/ftp/python/$PYTHON_VERSION/$PYTHON_TGZ"
    tar -xf "$PYTHON_TGZ"
    cd "$PYTHON_SRC"
    ./configure --enable-optimizations
    make -j$(nproc)
    make altinstall

    # Clean apt cache to free space
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # Ensure pip is available for python3.12
    /usr/local/bin/python3.12 -m ensurepip
    /usr/local/bin/python3.12 -m pip install --upgrade pip setuptools
    /usr/local/bin/python3.12 -m pip install --force-reinstall cffi

    # Remove any old torch installations
    /usr/local/bin/python3.12 -m pip uninstall -y torch torchvision || true
    rm -rf /usr/local/lib/python3.12/site-packages/torch*
    rm -rf /usr/local/lib/python3.12/site-packages/torchvision*

    # Install requirements
    /usr/local/bin/python3.12 -m pip install -r /opt/context/requirement.txt

    # Clean up build files
    rm -rf "$WORKDIR"
    ln -sf /usr/local/bin/python3.12 /usr/local/bin/python

%runscript
    # Bind the current directory for dynamic access
    export PYTHONPATH=$PWD
    exec "$@"

%labels
    Version 1.0